name: Update README with GitHub Stats

on:
  schedule:
    # Run every hour
    - cron: '0 * * * *'
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  update-readme:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Update README with GitHub stats
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');

            // Fetch open PRs with details
            const prsOpen = await github.rest.search.issuesAndPullRequests({
              q: 'author:Abiji-2020 type:pr state:open',
              per_page: 10,
              sort: 'updated',
              order: 'desc'
            });

            // Fetch recently closed/merged PRs
            const prsClosed = await github.rest.search.issuesAndPullRequests({
              q: 'author:Abiji-2020 type:pr state:closed',
              per_page: 20,
              sort: 'updated',
              order: 'desc'
            });

            // Fetch merged PRs count
            const prsMergedCount = await github.rest.search.issuesAndPullRequests({
              q: 'author:Abiji-2020 type:pr is:merged',
              per_page: 1
            });

            // Fetch closed but not merged PRs count
            const prsClosedNotMergedCount = await github.rest.search.issuesAndPullRequests({
              q: 'author:Abiji-2020 type:pr is:closed -is:merged',
              per_page: 1
            });

            // Fetch issues count
            const issues = await github.rest.search.issuesAndPullRequests({
              q: 'author:Abiji-2020 type:issue',
              per_page: 1
            });

            const openPRCount = prsOpen.data.total_count;
            const mergedPRCount = prsMergedCount.data.total_count;
            const issuesCount = issues.data.total_count;

            // Build open PRs list with SVG icons
            let prsList = '';
            if (openPRCount > 0) {
              prsList = '### ðŸ”„ Currently Working On\n\n';
              prsOpen.data.items.forEach((pr) => {
                const prNumber = pr.number;
                const repo = pr.repository_url.split('/').slice(-1)[0];
                const owner = pr.repository_url.split('/').slice(-2, -1)[0];
                prsList += `<img src="./asset/open-pr.svg" width="24" height="24" alt="Open PR" style="vertical-align:text-bottom;margin-right:6px;"/> [${pr.title}](${pr.html_url}) - \`${owner}/${repo}#${prNumber}\`\n`;
              });
              prsList += '\n';
            } else {
              prsList = '### ðŸ”„ Currently Working On\n\nNo active pull requests at the moment.\n\n';
            }

            // Build recently closed PRs list with emoji differentiation
            if (prsClosed.data.items.length > 0) {
              // Separate merged and closed PRs
              const mergedPRs = [];
              const closedNotMergedPRs = [];

              for (const pr of prsClosed.data.items) {
                // Check if PR is merged by looking at the merged_at field
                // Extract owner and repo from the repository URL
                const prOwner = pr.repository_url.split('/').slice(-2, -1)[0];
                const prRepo = pr.repository_url.split('/').slice(-1)[0];
                
                const prDetails = await github.rest.pulls.get({
                  owner: prOwner,
                  repo: prRepo,
                  pull_number: pr.number
                });

                if (prDetails.data.merged) {
                  mergedPRs.push(pr);
                } else {
                  closedNotMergedPRs.push(pr);
                }

                // Limit to 5 total
                if (mergedPRs.length + closedNotMergedPRs.length >= 5) break;
              }

              // Add merged PRs section
              if (mergedPRs.length > 0) {
                prsList += '### âœ… Recently Merged\n\n';
                mergedPRs.forEach((pr) => {
                  const prNumber = pr.number;
                  const repo = pr.repository_url.split('/').slice(-1)[0];
                  const owner = pr.repository_url.split('/').slice(-2, -1)[0];
                  prsList += `<img src="./asset/merge-pr.svg" width="24" height="24" alt="Merged PR" style="vertical-align:text-bottom;margin-right:6px;"/> [${pr.title}](${pr.html_url}) - \`${owner}/${repo}#${prNumber}\`\n`;
                });
                prsList += '\n';
              }

              // Add closed (not merged) PRs section
              if (closedNotMergedPRs.length > 0) {
                prsList += '### âŒ Recently Closed (Not Merged)\n\n';
                closedNotMergedPRs.forEach((pr) => {
                  const prNumber = pr.number;
                  const repo = pr.repository_url.split('/').slice(-1)[0];
                  const owner = pr.repository_url.split('/').slice(-2, -1)[0];
                  prsList += `<img src="./asset/closed-pr.svg" width="24" height="24" alt="Closed PR" style="vertical-align:text-bottom;margin-right:6px;"/> [${pr.title}](${pr.html_url}) - \`${owner}/${repo}#${prNumber}\`\n`;
                });
                prsList += '\n';
              }
            }

            // Build stats table (with header)
            const statsTable = `| Metric | Link |\n|--------|------|\n| **Open Pull Requests** | [![PRs](https://img.shields.io/badge/Open%20PRs-${openPRCount}-blue?style=flat-square)](https://github.com/pulls?q=author%3AAbiji-2020+type%3Apr+state%3Aopen) |\n| **Merged Pull Requests** | [![Merged PRs](https://img.shields.io/badge/Merged%20PRs-${prsMergedCount.data.total_count}-green?style=flat-square)](https://github.com/pulls?q=author%3AAbiji-2020+type%3Apr+is%3Amerged) |\n| **Closed (Not Merged)** | [![Closed](https://img.shields.io/badge/Closed-${prsClosedNotMergedCount.data.total_count}-red?style=flat-square)](https://github.com/pulls?q=author%3AAbiji-2020+type%3Apr+is%3Aclosed+-is%3Amerged) |\n| **Total Issues Created** | [![Issues](https://img.shields.io/badge/Issues-${issuesCount}-orange?style=flat-square)](https://github.com/issues?q=author%3AAbiji-2020+type%3Aissue) |`;

            // Read the README file
            let readmeContent = fs.readFileSync('README.md', 'utf8');

            // Replace the stats section strictly between markers to avoid malformed comments
            const statsMarkerStart = '<!-- GITHUB-STATS:START -->';
            const statsMarkerEnd = '<!-- GITHUB-STATS:END -->';
            const ghStartIdx = readmeContent.indexOf(statsMarkerStart);
            const ghEndIdx = readmeContent.indexOf(statsMarkerEnd);
            if (ghStartIdx !== -1 && ghEndIdx !== -1 && ghEndIdx > ghStartIdx) {
              const before = readmeContent.substring(0, ghStartIdx + statsMarkerStart.length);
              const after = readmeContent.substring(ghEndIdx);
              const statsBlock = `\n<div align="center">\n\n${statsTable}\n\n</div>\n`;
              readmeContent = before + statsBlock + after;
            }

            // Find and replace the open PRs section
            const activePRStart = readmeContent.indexOf('<!-- ACTIVE-PRS:START -->');
            const activePREnd = readmeContent.indexOf('<!-- ACTIVE-PRS:END -->');

            if (activePRStart !== -1 && activePREnd !== -1) {
              const newPRSection = `<!-- ACTIVE-PRS:START -->\n${prsList}<!-- ACTIVE-PRS:END -->`;
              readmeContent = readmeContent.substring(0, activePRStart) + newPRSection + readmeContent.substring(activePREnd + 24);
            }

            // Write the updated content back
            fs.writeFileSync('README.md', readmeContent, 'utf8');
            console.log(`Updated README: ${openPRCount} open PRs, ${mergedPRCount} merged, ${issuesCount} issues`);

      - name: Commit and push changes
        run: >
          git config --local user.email "action@github.com" &&
          git config --local user.name "GitHub Action" &&
          if git diff --quiet README.md; then
            echo "No changes to commit";
          else
            git add README.md &&
            git commit -m "chore: update README with latest GitHub stats" &&
            git push;
          fi
