name: Update README with GitHub Stats

on:
  schedule:
    # Run every hour
    - cron: '0 * * * *'
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  update-readme:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Update README with GitHub stats
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');

            // Fetch open PRs with details
            const prsOpen = await github.rest.search.issuesAndPullRequests({
              q: 'author:Abiji-2020 type:pr state:open',
              per_page: 10,
              sort: 'updated',
              order: 'desc'
            });

            // Fetch recently closed/merged PRs
            const prsClosed = await github.rest.search.issuesAndPullRequests({
              q: 'author:Abiji-2020 type:pr state:closed',
              per_page: 5,
              sort: 'updated',
              order: 'desc'
            });

            // Fetch merged PRs count
            const prsMergedCount = await github.rest.search.issuesAndPullRequests({
              q: 'author:Abiji-2020 type:pr state:closed',
              per_page: 1
            });

            // Fetch issues count
            const issues = await github.rest.search.issuesAndPullRequests({
              q: 'author:Abiji-2020 type:issue',
              per_page: 1
            });

            const openPRCount = prsOpen.data.total_count;
            const mergedPRCount = prsMergedCount.data.total_count;
            const issuesCount = issues.data.total_count;

            // Build open PRs list with emoji
            let prsList = '';
            if (openPRCount > 0) {
              prsList = '### ðŸ”„ Currently Working On\n\n';
              prsOpen.data.items.forEach((pr) => {
                const prNumber = pr.number;
                const repo = pr.repository_url.split('/').slice(-1)[0];
                const owner = pr.repository_url.split('/').slice(-2, -1)[0];
                prsList += `- ðŸŸ¢ [${pr.title}](${pr.html_url}) - \`${owner}/${repo}#${prNumber}\`\n`;
              });
              prsList += '\n';
            } else {
              prsList = '### ðŸ”„ Currently Working On\n\nNo active pull requests at the moment.\n\n';
            }

            // Build recently closed PRs list with emoji
            if (prsClosed.data.items.length > 0) {
              prsList += '### âœ… Recently Closed/Merged\n\n';
              prsClosed.data.items.forEach((pr) => {
                const prNumber = pr.number;
                const repo = pr.repository_url.split('/').slice(-1)[0];
                const owner = pr.repository_url.split('/').slice(-2, -1)[0];
                prsList += `- âœ“ [${pr.title}](${pr.html_url}) - \`${owner}/${repo}#${prNumber}\`\n`;
              });
              prsList += '\n';
            }

            // Build stats table (with header)
            const statsTable = `| Metric | Link |\n|--------|------|\n| **Open Pull Requests** | [![PRs](https://img.shields.io/badge/Open%20PRs-${openPRCount}-blue?style=flat-square)](https://github.com/pulls?q=author%3AAbiji-2020+type%3Apr+state%3Aopen) |\n| **Merged Pull Requests** | [![Merged PRs](https://img.shields.io/badge/Merged%20PRs-${mergedPRCount}-green?style=flat-square)](https://github.com/pulls?q=author%3AAbiji-2020+type%3Apr+state%3Aclosed) |\n| **Total Issues Created** | [![Issues](https://img.shields.io/badge/Issues-${issuesCount}-orange?style=flat-square)](https://github.com/issues?q=author%3AAbiji-2020+type%3Aissue) |`;

            // Read the README file
            let readmeContent = fs.readFileSync('README.md', 'utf8');

            // Replace the entire stats section (from header to closing div)
            const statsStart = readmeContent.indexOf('| Metric | Link |');
            const statsEnd = readmeContent.indexOf('</div>', statsStart) + 6;

            if (statsStart !== -1 && statsEnd > statsStart) {
              const beforeStats = readmeContent.substring(0, statsStart);
              const afterStats = readmeContent.substring(statsEnd);
              readmeContent = beforeStats + statsTable + '\n' + afterStats;
            }

            // Find and replace the open PRs section
            const activePRStart = readmeContent.indexOf('<!-- ACTIVE-PRS:START -->');
            const activePREnd = readmeContent.indexOf('<!-- ACTIVE-PRS:END -->');

            if (activePRStart !== -1 && activePREnd !== -1) {
              const newPRSection = `<!-- ACTIVE-PRS:START -->\n${prsList}<!-- ACTIVE-PRS:END -->`;
              readmeContent = readmeContent.substring(0, activePRStart) + newPRSection + readmeContent.substring(activePREnd + 24);
            }

            // Write the updated content back
            fs.writeFileSync('README.md', readmeContent, 'utf8');
            console.log(`Updated README: ${openPRCount} open PRs, ${mergedPRCount} merged, ${issuesCount} issues`);

      - name: Commit and push changes
        run: >
          git config --local user.email "action@github.com" &&
          git config --local user.name "GitHub Action" &&
          if git diff --quiet README.md; then
            echo "No changes to commit";
          else
            git add README.md &&
            git commit -m "chore: update README with latest GitHub stats" &&
            git push;
          fi
